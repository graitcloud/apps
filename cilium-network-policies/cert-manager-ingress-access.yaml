apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: cert-manager-ingress-access
  labels:
    managed-by: platform
    component: cert-manager
    priority: high
  annotations:
    description: "High-priority policy for complete cert-manager workflow: allows cert-manager access to ingress controllers (ports 80,443) and ingress controller access to ACME HTTP solver pods (port 8089)"
spec:
  # Target ingress controllers in restricted namespaces with network permission
  endpointSelector:
    matchExpressions:
      - key: padmini.systems/tenant-resource-type
        operator: In
        values: ["ingress"]
      - key: padmini.systems/network-permission
        operator: In
        values: ["allow"]
      - key: io.cilium.k8s.namespace.labels.access
        operator: In
        values: ["restricted"]

  ingress:
    # Allow cert-manager pods to access ingress controllers on port 80 for ACME challenges
    - fromEndpoints:
        - matchLabels:
            app.kubernetes.io/instance: cert-manager
          matchExpressions:
            - key: k8s:io.kubernetes.pod.namespace
              operator: In
              values: ["cert-manager"]
      toPorts:
        - ports:
            - port: "80"
              protocol: TCP
            - port: "443"
              protocol: TCP

  egress:
    # Allow ingress controllers to reach ACME HTTP solver pods for certificate validation
    - toEndpoints:
        - matchLabels:
            acme.cert-manager.io/http01-solver: "true"
      toPorts:
        - ports:
            - port: "8089"
              protocol: TCP